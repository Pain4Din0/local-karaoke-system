<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Player</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Noto+Sans+JP:wght@400;700&family=Noto+Sans+SC:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans SC', 'Noto Sans JP', sans-serif;
        }

        body.hide-cursor {
            cursor: none;
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.5s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }
    </style>
</head>

<body class="bg-black text-white overflow-hidden h-screen w-screen selection:bg-white selection:text-black">
    <div id="app" class="relative w-full h-full">

        <div v-if="!hasInteracted" @click="startInteraction"
            class="absolute inset-0 z-50 bg-black flex flex-col items-center justify-center cursor-pointer">
            <div class="border border-white/20 hover:bg-white/10 transition-colors rounded-full p-6 mb-4 animate-pulse">
                <i class="ri-hand-coin-line text-4xl"></i>
            </div>
            <p class="text-xs tracking-[0.2em] text-gray-500 uppercase">Click to Initialize System</p>
        </div>

        <div id="artplayer" class="w-full h-full absolute top-0 left-0 z-10"></div>

        <div v-if="!isPlayingVideo && hasInteracted"
            class="absolute inset-0 flex items-center justify-center z-20 bg-black">
            <div class="w-full max-w-5xl px-8">

                <div v-if="currentSong && currentSong.status !== 'ready'"
                    class="space-y-6 text-center max-w-2xl mx-auto">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-xs font-mono text-gray-400">DOWNLOADING</span>
                        <span class="text-xs font-mono text-white">{{ Math.floor(currentSong.progress || 0) }}%</span>
                    </div>
                    <div class="w-full h-[1px] bg-gray-800 overflow-hidden">
                        <div class="h-full bg-white transition-all duration-300 ease-out"
                            :style="{width: (currentSong.progress || 0) + '%'}"></div>
                    </div>
                    <p class="text-3xl font-light text-white truncate mt-8 opacity-80">{{ currentSong.title }}</p>
                </div>

                <div v-else class="flex flex-col md:flex-row items-center justify-center gap-12 select-none">

                    <div @click="nextNetwork" class="relative group cursor-pointer"
                        title="Click to switch network interface">
                        <div
                            class="bg-white p-4 rounded-xl shadow-2xl transition-transform group-hover:scale-105 duration-300 border-4 border-transparent group-hover:border-zinc-700">
                            <div id="qrcode" class="w-[220px] h-[220px]"></div>
                        </div>

                        <div v-if="networks.length > 1" class="absolute -bottom-10 left-0 w-full text-center">
                            <p
                                class="text-[10px] uppercase tracking-widest text-zinc-500 group-hover:text-white transition-colors bg-black/50 py-1 rounded">
                                <i class="ri-arrow-left-right-line align-middle mr-1"></i> Click QR to Switch
                            </p>
                            <div class="flex justify-center gap-1.5 mt-2">
                                <div v-for="(net, idx) in networks" :key="idx"
                                    class="w-1.5 h-1.5 rounded-full transition-all"
                                    :class="idx === currentNetIndex ? 'bg-white' : 'bg-zinc-800'"></div>
                            </div>
                        </div>
                    </div>

                    <div class="text-left space-y-8 min-w-[300px]">
                        <div>
                            <p class="text-xs text-zinc-500 font-mono tracking-widest uppercase mb-2">Current Network
                            </p>
                            <div
                                class="inline-flex items-center gap-2 border border-zinc-800 px-3 py-1 rounded-full bg-zinc-900">
                                <i class="ri-router-line text-zinc-400 text-sm"></i>
                                <span class="text-sm font-medium text-zinc-300">{{ currentNetwork.name }}</span>
                            </div>
                        </div>

                        <div>
                            <p class="text-xs text-zinc-500 font-mono tracking-widest uppercase mb-2">Connect via URL
                            </p>
                            <p class="text-3xl font-light text-white tracking-tight break-all cursor-text select-text">
                                <span class="text-zinc-600">http://</span>{{ currentNetwork.ip }}<span
                                    class="text-zinc-600">:{{ systemPort }}</span>
                            </p>
                        </div>

                        <div class="pt-4 border-t border-zinc-900">
                            <div class="flex items-center gap-2 text-zinc-500">
                                <i class="ri-wifi-line"></i>
                                <span class="text-xs uppercase tracking-wider">Host SSID: {{ systemSSID }}</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div v-if="isPlayingVideo && showInfo"
            class="absolute top-12 left-12 max-w-3xl z-30 pointer-events-none animate-fade-in-down">
            <h1 class="text-5xl font-bold leading-tight drop-shadow-lg mb-2 line-clamp-2">{{ currentSong.title }}</h1>
            <div class="flex items-center gap-4 text-lg font-light text-gray-200 drop-shadow-md">
                <span class="bg-white/20 px-2 py-0.5 text-xs rounded uppercase tracking-wider">Requested By</span>
                <span>{{ currentSong.requester }}</span>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, nextTick, watch } = Vue;
        const socket = io();
        let art = null;
        let tickInterval = null;

        createApp({
            setup() {
                const currentSong = ref(null);
                const showInfo = ref(false);
                const hasInteracted = ref(false);
                const systemInfo = ref({ ssid: 'Loading...', url: 'Loading...', ip: '' });
                const isPlayingVideo = computed(() => currentSong.value && currentSong.value.status === 'ready');

                const networks = ref([{ name: 'Loading', ip: '...' }]);
                const currentNetIndex = ref(0);
                const systemSSID = ref('...');
                const systemPort = ref('8080');

                const currentNetwork = computed(() => networks.value[currentNetIndex.value] || networks.value[0]);

                watch(isPlayingVideo, (playing) => {
                    if (playing) {
                        document.body.classList.add('hide-cursor');
                    } else {
                        document.body.classList.remove('hide-cursor');
                    }
                });

                const nextNetwork = () => {
                    if (networks.value.length <= 1) return;
                    currentNetIndex.value = (currentNetIndex.value + 1) % networks.value.length;
                    nextTick(() => generateQR());
                };

                const startInteraction = () => {
                    hasInteracted.value = true;
                    if (art) art.play().catch(() => { });
                    if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(() => { });

                    nextTick(() => generateQR());
                };

                const generateQR = () => {
                    const container = document.getElementById('qrcode');
                    if (container && currentNetwork.value.ip !== '...') {
                        container.innerHTML = '';
                        const url = `http://${currentNetwork.value.ip}:${systemPort.value}/controller.html`;
                        new QRCode(container, {
                            text: url,
                            width: 220,
                            height: 220,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.L
                        });
                    }
                };

                const startHeartbeat = () => {
                    if (tickInterval) clearInterval(tickInterval);
                    tickInterval = setInterval(() => {
                        if (art && art.video) {
                            socket.emit('player_tick', {
                                playing: !art.video.paused,
                                currentTime: art.currentTime,
                                duration: art.duration,
                                volume: art.volume
                            });
                        }
                    }, 1000);
                };

                const initPlayer = (url) => {
                    if (art) { art.destroy(false); art = null; }
                    art = new Artplayer({
                        container: '#artplayer',
                        url: url,
                        autoplay: true,
                        volume: 0.8,
                        isLive: false,
                        autoSize: true,
                        fullscreen: true,
                        theme: '#ffffff',
                    });
                    art.on('video:ended', () => socket.emit('next_song'));
                    art.on('ready', () => {
                        if (hasInteracted.value) art.play().catch(() => { });
                        startHeartbeat();
                        socket.emit('player_tick', { playing: true, currentTime: 0, duration: art.duration, volume: 0.8 });
                    });
                };

                socket.on('system_info', (info) => {
                    networks.value = info.networks;
                    systemSSID.value = info.ssid;
                    systemPort.value = info.port;
                    if (!isPlayingVideo.value && hasInteracted.value) {
                        nextTick(() => generateQR());
                    }
                });

                socket.on('sync_state', (state) => {
                    const newSong = state.currentPlaying;
                    const oldSong = currentSong.value;
                    currentSong.value = newSong;

                    if (newSong && newSong.status === 'ready') {
                        const isSameSong = oldSong && oldSong.id === newSong.id;
                        const wasReady = oldSong && oldSong.status === 'ready';

                        if (!isSameSong || !wasReady || !art) {
                            initPlayer(newSong.src);
                            showInfo.value = true;
                            setTimeout(() => showInfo.value = false, 8000);
                        }
                    } else if (!newSong) {
                        if (art) { art.destroy(); art = null; }
                        if (tickInterval) clearInterval(tickInterval);
                        if (hasInteracted.value) nextTick(() => generateQR());
                    }
                });

                socket.on('update_progress', ({ id, progress }) => {
                    if (currentSong.value && currentSong.value.id === id) currentSong.value.progress = progress;
                });

                socket.on('exec_control', (action) => {
                    if (!art) return;
                    switch (action.type) {
                        case 'toggle': art.toggle(); break;
                        case 'seek': art.currentTime = action.value; art.notice.show = `${formatTime(action.value)}`; break;
                        case 'volume': art.volume = action.value; art.notice.show = `VOL ${Math.round(action.value * 100)}`; break;
                        case 'seek_fwd': art.forward = 5; break;
                        case 'seek_rew': art.backward = 5; break;
                        case 'replay': art.currentTime = 0; art.play(); break;
                        case 'reload': location.reload(); break;
                    }
                    setTimeout(() => {
                        if (art) socket.emit('player_tick', {
                            playing: !art.video.paused,
                            currentTime: art.currentTime,
                            duration: art.duration,
                            volume: art.volume
                        });
                    }, 50);
                });

                const formatTime = (seconds) => {
                    const m = Math.floor(seconds / 60);
                    const s = Math.floor(seconds % 60);
                    return `${m}:${s.toString().padStart(2, '0')}`;
                };

                return { currentSong, isPlayingVideo, showInfo, hasInteracted, startInteraction, networks, currentNetwork, currentNetIndex, nextNetwork, systemSSID, systemPort };
            }
        }).mount('#app');
    </script>
    <style>
        .animate-fade-in-down {
            animation: fadeInDown 0.8s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</body>

</html>